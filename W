-- LocalScript trong StarterPlayerScripts ho·∫∑c StarterGui

-- ================== UI SETUP ==================
local player = game.Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "BrainrotOverlay"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

-- Background Frame
local bgFrame = Instance.new("Frame")
bgFrame.Size = UDim2.new(1, 0, 1, 0)
bgFrame.Position = UDim2.new(0, 0, 0, 0)
bgFrame.BackgroundColor3 = Color3.fromRGB(8, 8, 12)
bgFrame.BorderSizePixel = 0
bgFrame.Parent = screenGui

-- Gradient n·ªÅn
local bgGrad = Instance.new("UIGradient")
bgGrad.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Color3.fromRGB(10, 5, 20)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(3, 3, 10))
})
bgGrad.Rotation = 135
bgGrad.Parent = bgFrame

-- Card ch√≠nh
local card = Instance.new("Frame")
card.Size = UDim2.new(0, 420, 0, 220)
card.Position = UDim2.new(0.5, -210, 0.5, -110)
card.BackgroundColor3 = Color3.fromRGB(18, 18, 28)
card.BorderSizePixel = 0
card.Parent = bgFrame

local cardCorner = Instance.new("UICorner")
cardCorner.CornerRadius = UDim.new(0, 16)
cardCorner.Parent = card

local cardStroke = Instance.new("UIStroke")
cardStroke.Color = Color3.fromRGB(120, 60, 220)
cardStroke.Thickness = 2
cardStroke.Transparency = 0.3
cardStroke.Parent = card

-- Top accent bar
local accentBar = Instance.new("Frame")
accentBar.Size = UDim2.new(1, 0, 0, 4)
accentBar.Position = UDim2.new(0, 0, 0, 0)
accentBar.BackgroundColor3 = Color3.fromRGB(150, 80, 255)
accentBar.BorderSizePixel = 0
accentBar.Parent = card

local accentGrad = Instance.new("UIGradient")
accentGrad.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Color3.fromRGB(100, 40, 255)),
    ColorSequenceKeypoint.new(0.5, Color3.fromRGB(200, 100, 255)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 80, 180))
})
accentGrad.Parent = accentBar

local accentCorner = Instance.new("UICorner")
accentCorner.CornerRadius = UDim.new(0, 4)
accentCorner.Parent = accentBar

-- Icon + Title
local titleRow = Instance.new("Frame")
titleRow.Size = UDim2.new(1, -30, 0, 40)
titleRow.Position = UDim2.new(0, 15, 0, 18)
titleRow.BackgroundTransparency = 1
titleRow.Parent = card

local iconLabel = Instance.new("TextLabel")
iconLabel.Size = UDim2.new(0, 36, 0, 36)
iconLabel.Position = UDim2.new(0, 0, 0, 0)
iconLabel.BackgroundTransparency = 1
iconLabel.Text = "üß†"
iconLabel.TextScaled = true
iconLabel.Parent = titleRow

local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1, -46, 1, 0)
titleLabel.Position = UDim2.new(0, 46, 0, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "Brainrot Finder"
titleLabel.TextColor3 = Color3.fromRGB(220, 200, 255)
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextScaled = true
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.Parent = titleRow

-- Divider
local divider = Instance.new("Frame")
divider.Size = UDim2.new(1, -30, 0, 1)
divider.Position = UDim2.new(0, 15, 0, 65)
divider.BackgroundColor3 = Color3.fromRGB(60, 50, 90)
divider.BorderSizePixel = 0
divider.Parent = card

-- Status label
local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1, -30, 0, 36)
statusLabel.Position = UDim2.new(0, 15, 0, 76)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "‚è≥ Initializing..."
statusLabel.TextColor3 = Color3.fromRGB(180, 160, 220)
statusLabel.Font = Enum.Font.GothamSemibold
statusLabel.TextScaled = true
statusLabel.TextXAlignment = Enum.TextXAlignment.Left
statusLabel.Parent = card

-- Server info label
local serverLabel = Instance.new("TextLabel")
serverLabel.Size = UDim2.new(1, -30, 0, 26)
serverLabel.Position = UDim2.new(0, 15, 0, 118)
serverLabel.BackgroundTransparency = 1
serverLabel.Text = ""
serverLabel.TextColor3 = Color3.fromRGB(130, 120, 160)
serverLabel.Font = Enum.Font.Gotham
serverLabel.TextScaled = true
serverLabel.TextXAlignment = Enum.TextXAlignment.Left
serverLabel.Parent = card

-- Hop counter label
local hopLabel = Instance.new("TextLabel")
hopLabel.Size = UDim2.new(1, -30, 0, 26)
hopLabel.Position = UDim2.new(0, 15, 0, 150)
hopLabel.BackgroundTransparency = 1
hopLabel.Text = "üîÅ Servers hopped: 0"
hopLabel.TextColor3 = Color3.fromRGB(130, 120, 160)
hopLabel.Font = Enum.Font.Gotham
hopLabel.TextScaled = true
hopLabel.TextXAlignment = Enum.TextXAlignment.Left
hopLabel.Parent = card

-- Progress bar bg
local progressBg = Instance.new("Frame")
progressBg.Size = UDim2.new(1, -30, 0, 8)
progressBg.Position = UDim2.new(0, 15, 0, 186)
progressBg.BackgroundColor3 = Color3.fromRGB(35, 30, 55)
progressBg.BorderSizePixel = 0
progressBg.Parent = card
Instance.new("UICorner", progressBg).CornerRadius = UDim.new(0, 4)

local progressBar = Instance.new("Frame")
progressBar.Size = UDim2.new(0, 0, 1, 0)
progressBar.BackgroundColor3 = Color3.fromRGB(150, 80, 255)
progressBar.BorderSizePixel = 0
progressBar.Parent = progressBg
Instance.new("UICorner", progressBar).CornerRadius = UDim.new(0, 4)

local progressGrad = Instance.new("UIGradient")
progressGrad.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Color3.fromRGB(100, 40, 255)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 80, 180))
})
progressGrad.Parent = progressBar

-- Pulse animation cho card stroke
task.spawn(function()
    local t = 0
    while true do
        t += 0.05
        cardStroke.Transparency = 0.3 + math.sin(t) * 0.25
        task.wait(0.05)
    end
end)

-- H√†m c·∫≠p nh·∫≠t UI
local function setStatus(icon, msg, color)
    statusLabel.Text = icon .. " " .. msg
    statusLabel.TextColor3 = color or Color3.fromRGB(180, 160, 220)
end

local function setProgress(pct) -- 0.0 -> 1.0
    progressBar:TweenSize(UDim2.new(pct, 0, 1, 0), Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.3, true)
end

-- ================== GUARD ==================
if shared.__BRAINROT_WEBHOOK_SENT then return end
shared.__BRAINROT_WEBHOOK_SENT = true

repeat task.wait() until game:IsLoaded()

-- ================== SERVICES ==================
local Players        = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService    = game:GetService("HttpService")
local Workspace      = game:GetService("Workspace")
local TweenService   = game:GetService("TweenService")

local placeId = game.PlaceId
local jobId   = game.JobId

-- ================== CONFIG ==================
local WEBHOOK_URL  = "https://discord.com/api/webhooks/1472498140409102462/Ijb7ppZ8IZVFbTz2mSySRr3M9487k60ysmNZ2NFm8KlozX41BunCspHfA06Je-4N1WBm"
local PRICE_LIMIT  = 5_000_000
local MAX_DISTANCE = 5

-- ================== HELPERS ==================
local function debugPrint(...) print("[BRAINROT]", ...) end

local function parseGeneration(text)
    if not text then return 0 end
    local num = tonumber(text:match("[%d%.]+")) or 0
    if text:find("K") then num *= 1e3
    elseif text:find("M") then num *= 1e6 end
    return num
end

local function getInstanceWorldPos(inst)
    if inst:IsA("BasePart") then return inst.Position end
    if inst:IsA("Model") then
        return inst.PrimaryPart and inst.PrimaryPart.Position or inst:GetPivot().Position
    end
end

local function getBaseNameFromPlot(plot)
    local sign = plot:FindFirstChild("PlotSign")
        and plot.PlotSign:FindFirstChild("SurfaceGui")
        and plot.PlotSign.SurfaceGui:FindFirstChild("Frame")
        and plot.PlotSign.SurfaceGui.Frame:FindFirstChild("TextLabel")
    return sign and sign.Text or "Unknown Base"
end

-- ================== SCAN ==================
local function collectBrainrot()
    local found = {}
    local plots       = Workspace:FindFirstChild("Plots")
    local debrisFolder = Workspace:FindFirstChild("Debris")
    if not plots or not debrisFolder then
        debugPrint("‚ùå Missing Plots or Debris")
        return found
    end

    local plotList = plots:GetChildren()
    for idx, plot in ipairs(plotList) do
        setProgress(idx / #plotList)
        serverLabel.Text = "üîç Scanning plot " .. idx .. "/" .. #plotList
        debugPrint("Scanning plot:", plot.Name)

        local baseName = getBaseNameFromPlot(plot)
        local podiums  = plot:FindFirstChild("AnimalPodiums")
        if not podiums then continue end

        for _, podium in ipairs(podiums:GetChildren()) do
            local att = podium:FindFirstChild("Base")
                and podium.Base:FindFirstChild("Spawn")
                and podium.Base.Spawn:FindFirstChild("Attachment")
            if not att then continue end
            local attPos = att.WorldPosition

            local nearest, nearestDist
            for _, debris in ipairs(debrisFolder:GetChildren()) do
                local overhead = debris:FindFirstChild("AnimalOverhead")
                if not overhead then continue end
                local nameLabel = overhead:FindFirstChild("DisplayName")
                local genLabel  = overhead:FindFirstChild("Generation")
                if not nameLabel or not genLabel then continue end
                local debrisPos = getInstanceWorldPos(debris)
                if not debrisPos then continue end
                local dist = (debrisPos - attPos).Magnitude
                if dist <= MAX_DISTANCE and (not nearestDist or dist < nearestDist) then
                    nearestDist = dist
                    nearest = {
                        name     = nameLabel.Text,
                        genText  = genLabel.Text,
                        genValue = parseGeneration(genLabel.Text),
                        baseName = baseName
                    }
                end
            end

            if nearest and nearest.genValue >= PRICE_LIMIT then
                debugPrint("[MATCH]", nearest.name, nearest.genText, "Base:", nearest.baseName)
                table.insert(found, {
                    name     = nearest.name,
                    genText  = nearest.genText,
                    genValue = nearest.genValue,
                    baseName = nearest.baseName
                })
            end
        end
        task.wait()
    end
    return found
end

-- ================== WEBHOOK ==================
local function sendWebhook(loot)
    if #loot == 0 then debugPrint("No loot to send") return end

    local serverLink = ("https://kebabman.vercel.app/start?placeId=%s&gameInstanceId=%s")
        :format(placeId, tostring(jobId))

    -- Format loot list
    local lootLines = {}
    for _, item in ipairs(loot) do
        table.insert(lootLines, string.format("üêæ **%s** `%s`\n‚îî üè† %s", item.name, item.genText, item.baseName))
    end
    local lootStr = table.concat(lootLines, "\n\n")

    -- Format player list
    local playerNames = {}
    for _, p in ipairs(Players:GetPlayers()) do
        table.insert(playerNames, "‚Ä¢ " .. p.Name)
    end
    local playerStr = table.concat(playerNames, "\n")
    if playerStr == "" then playerStr = "N/A" end

    local payload = {
        content = "@everyone",
        embeds = {{
            title       = "üß† Brainrot Detected!",
            description = string.format(
                "**%d** valuable brainrot found in this server!\n[üöÄ Join Server](%s)",
                #loot, serverLink
            ),
            color = 10027263, -- purple
            fields = {
                {
                    name   = "üí∞ Loot (" .. #loot .. " found)",
                    value  = lootStr,
                    inline = false
                },
                {
                    name   = "üë• Players Online",
                    value  = playerStr,
                    inline = true
                },
                {
                    name   = "üìä Server Capacity",
                    value  = string.format("%d / 8", #Players:GetPlayers()),
                    inline = true
                },
                {
                    name   = "üåê Place ID",
                    value  = tostring(placeId),
                    inline = true
                }
            },
            footer = {
                text = "Brainrot Finder ‚Ä¢ Server: " .. tostring(jobId):sub(1, 18) .. "..."
            },
            timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
        }}
    }

    local req = (syn and syn.request) or http_request or (http and http.request) or request
    if req then
        debugPrint("üì§ Sending webhook")
        pcall(function()
            req({
                Url     = WEBHOOK_URL,
                Method  = "POST",
                Headers = { ["Content-Type"] = "application/json" },
                Body    = HttpService:JSONEncode(payload)
            })
        end)
    end
end

-- ================== MAIN SCAN ==================
setStatus("‚è≥", "Scanning server...", Color3.fromRGB(200, 180, 255))
setProgress(0)

local loot = collectBrainrot()
setProgress(1)

if #loot == 0 then
    setStatus("üòû", "No Brainrot Found", Color3.fromRGB(180, 100, 100))
    serverLabel.Text = "Moving to next server..."
    cardStroke.Color = Color3.fromRGB(180, 60, 60)
else
    setStatus("‚úÖ", "Webhook Sent! (" .. #loot .. " found)", Color3.fromRGB(100, 220, 140))
    serverLabel.Text = "Found in this server!"
    cardStroke.Color = Color3.fromRGB(80, 220, 120)
    progressBar.BackgroundColor3 = Color3.fromRGB(80, 200, 120)
    sendWebhook(loot)
end

-- ================== SERVER HOP ==================
-- Nh·∫≠n danh s√°ch ƒë√£ hop t·ª´ l·∫ßn tr∆∞·ªõc (ƒë∆∞·ª£c truy·ªÅn qua queue_on_teleport)
local visitedServers = shared.__VISITED_SERVERS or {}
table.insert(visitedServers, jobId) -- ƒë√°nh d·∫•u server hi·ªán t·∫°i
shared.__VISITED_SERVERS = visitedServers

local hopCount = shared.__HOP_COUNT or 0

local function buildNextScript()
    return string.format([[
        shared.__VISITED_SERVERS = %s
        shared.__HOP_COUNT = %d
        -- Paste l·∫°i to√†n b·ªô script ·ªü ƒë√¢y ho·∫∑c loadstring t·ª´ URL n·∫øu c√≥ remote loader
    ]], HttpService:JSONEncode(visitedServers), hopCount + 1)
end

local function serverHop()
    hopCount += 1
    shared.__HOP_COUNT = hopCount
    hopLabel.Text = "üîÅ Servers hopped: " .. hopCount
    setStatus("üîÅ", "Server hopping...", Color3.fromRGB(150, 150, 220))

    local ok, raw = pcall(function()
        return game:HttpGet(
            "https://games.roblox.com/v1/games/" .. placeId ..
            "/servers/Public?sortOrder=Asc&limit=100&excludeFullGames=true"
        )
    end)

    local candidates = {}
    if ok and raw then
        local body = HttpService:JSONDecode(raw)
        if body and body.data then
            for _, v in ipairs(body.data) do
                if  type(v) == "table"
                and tonumber(v.playing)
                and tonumber(v.maxPlayers)
                and v.playing < v.maxPlayers
                and v.id ~= jobId
                -- B·ªè qua server ƒë√£ t·ª´ng hop v√†o
                and not table.find(visitedServers, v.id)
                then
                    table.insert(candidates, v.id)
                end
            end
        end
    end

    if #candidates == 0 then
        -- N·∫øu h·∫øt server m·ªõi th√¨ x√≥a l·ªãch s·ª≠ c≈© (gi·ªØ l·∫°i 20 server g·∫ßn nh·∫•t)
        debugPrint("‚ö†Ô∏è No new servers, clearing old history partially")
        if #visitedServers > 20 then
            local trimmed = {}
            for i = #visitedServers - 19, #visitedServers do
                table.insert(trimmed, visitedServers[i])
            end
            visitedServers = trimmed
            shared.__VISITED_SERVERS = visitedServers
        end

        -- Th·ª≠ l·∫°i
        ok, raw = pcall(function()
            return game:HttpGet(
                "https://games.roblox.com/v1/games/" .. placeId ..
                "/servers/Public?sortOrder=Desc&limit=100&excludeFullGames=true"
            )
        end)
        if ok and raw then
            local body = HttpService:JSONDecode(raw)
            if body and body.data then
                for _, v in ipairs(body.data) do
                    if  type(v) == "table"
                    and tonumber(v.playing)
                    and tonumber(v.maxPlayers)
                    and v.playing < v.maxPlayers
                    and v.id ~= jobId
                    and not table.find(visitedServers, v.id)
                    then
                        table.insert(candidates, v.id)
                    end
                end
            end
        end
    end

    if #candidates > 0 then
        local chosen = candidates[math.random(1, #candidates)]
        table.insert(visitedServers, chosen)
        shared.__VISITED_SERVERS = visitedServers
        serverLabel.Text = "üöÄ Hopping to new server..."
        debugPrint("Hopping to:", chosen, "| Visited:", #visitedServers, "servers")
        task.wait(0.5)
        TeleportService:TeleportToPlaceInstance(placeId, chosen, player)
    else
        setStatus("‚ö†Ô∏è", "No servers available", Color3.fromRGB(220, 180, 60))
        serverLabel.Text = "Retrying in 5s..."
        task.wait(5)
    end
end

task.wait(1.5)
while true do
    serverHop()
    task.wait(1)
end
